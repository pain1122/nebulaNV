NebulaNV â€” Refresh Token Implementation & Testing (21â€‘07â€‘2025)
ğŸ§© Module
apps/user-service/src/auth

âœ… What Was Done
â€¢ Refresh Token Flow Added
â€“ AuthService.login() now issues both an access token (moduleâ€‘configured secret) and a refresh token (refreshâ€‘only secret), hashes + stores the refresh token in the DB.
â€“ New refreshTokens() method: verifies incoming refresh token, checks against stored hash, rotates (new pair + DB update), returns fresh tokens.
â€¢ Controller Endpoint
â€“ Exposed POST /auth/refresh accepting a RefreshTokenDto.
â€“ ValidationPipe enforces the DTO and returns 401 on invalid or expired tokens.
â€¢ JWT Configuration Aligned
â€“ Switched JwtModule to registerAsync() pulling in JWT_ACCESS_SECRET / _EXPIRATION from Config.
â€“ Updated JwtStrategy to use JWT_ACCESS_SECRET.
â€“ Simplified login() to use moduleâ€™s default signing for access tokens.
â€¢ Testing Coverage
â€“ Unit tests in auth.service.spec.ts for error cases (invalid signature, hash mismatch) and happy path (rotation + DB update).
â€“ E2E tests in app.e2e.spec.ts for full flow: register â†’ login â†’ /auth/me â†’ /auth/refresh â†’ /auth/me with new token.

ğŸ—‚ï¸ Files & Directories Affected

csharp
Copy
Edit
apps/user-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ auth.service.ts           â¬…ï¸ Added refreshTokens(), updated login()
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts        â¬…ï¸ Added POST /auth/refresh
â”‚   â”‚   â”œâ”€â”€ auth.module.ts            â¬…ï¸ JwtModule.registerAsync()
â”‚   â”‚   â””â”€â”€ jwt/
â”‚   â”‚       â””â”€â”€ jwt.strategy.ts       â¬…ï¸ Uses JWT_ACCESS_SECRET
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ auth.service.spec.ts          â¬…ï¸ Unit tests for refreshTokens()
â”‚   â””â”€â”€ app.e2e.spec.ts               â¬…ï¸ E2E refreshâ€‘token flow
ğŸ§ª Feature Verification
âœ… Unit tests for AuthService.refreshTokens() â€” all cases pass.
âœ… E2E tests:

Register â†’ Login â†’ GET /auth/me returns 200

POST /auth/refresh returns new tokens (201)

New access token works on GET /auth/me (200)

â­ï¸ Next Steps (Future Phases)

Write unit tests for UserController.updateProfile, covering emailâ€‘only and passwordâ€‘change flows.

Begin gRPC integration, propagating JWT metadata from AuthService â†’ UserService.

Scaffold the Productâ€‘Service MVP with DTOs, guards, Prisma schema, controllers, and tests.

NebulaNV â€” gRPC Integration Kickoff (21â€‘07â€‘2025)
ğŸ§© Module
apps/user-service/src

âœ… What Was Done
â€¢ gRPC Server Bootstrapped
Â Â â€“ Added main.ts to launch a GRPC microservice on 0.0.0.0:50051 alongside HTTP.
Â Â â€“ Imported @nestjs/microservices, defined Transport.GRPC options (package user, protos/user.proto).
Â Â â€“ Hooked in global ValidationPipe for both REST and gRPC payloads.

â€¢ Protobuf Definition & Controller Scaffold
Â Â â€“ Created protos/user.proto with GetUser & UpdateProfile RPCs under service UserService.
Â Â â€“ Implemented UserGrpcController using @GrpcMethod('UserService', 'GetUser') and @GrpcMethod('UserService', 'UpdateProfile'), reâ€‘using UserService methods and mapping Nest exceptions to RpcException.

â€¢ gRPC Client in AuthService
Â Â â€“ Registered a named gRPC client (USER_SERVICE) in AuthModule via ClientsModule.registerAsync(), pulling USER_SERVICE_URL from ConfigService.
Â Â â€“ Defined a UserServiceClient interface (GetUser, UpdateProfile) to type the client.
Â Â â€“ Injected ClientGrpc in AuthService, initialized the typed client in onModuleInit().
Â Â â€“ Added imports of Metadata and firstValueFrom (rxjs) to prepare for metadataâ€‘driven calls.

ğŸ—‚ï¸ Files & Directories Affected

pgsql
Copy
Edit
apps/user-service/  
â”œâ”€â”€ src/  
â”‚   â”œâ”€â”€ auth/  
â”‚   â”‚   â”œâ”€â”€ auth.module.ts             â¬…ï¸ Registered GRPC client via ClientsModule  
â”‚   â”‚   â”œâ”€â”€ auth.service.ts            â¬…ï¸ Injected ClientGrpc + onModuleInit scaffolding  
â”‚   â”‚   â””â”€â”€ user-service-client.interface.ts  ğŸ†• Typed GRPC client interface  
â”‚   â”œâ”€â”€ auth/  
â”‚   â”‚   â””â”€â”€ grpc/  
â”‚   â”‚       â””â”€â”€ user-grpc.controller.ts ğŸ†• gRPC controller for GetUser & UpdateProfile  
â”‚   â”œâ”€â”€ protos/  
â”‚   â”‚   â””â”€â”€ user.proto                  ğŸ†• Protobuf definitions  
â”‚   â””â”€â”€ main.ts                         â¬…ï¸ Bootstraps HTTP + GRPC transports  
â””â”€â”€ test/  
    â””â”€â”€ (no changes yet)                â– gRPC tests pending  
ğŸ§ª What Has Been Verifed

Application starts with both REST (portÂ 3100) and gRPC (portÂ 50051) listenersâ€”no runtime errors.

Protobuf compiles and Nest recognizes @GrpcMethod handlers.

gRPC client can be injected in AuthService without TypeScript errors.

â­ï¸ Next Steps

Wire up actual calls in AuthService
Â Â Â â€¢ Swap a direct DB lookup (e.g. getUserById) for a gRPC this.userClient.GetUser(...) call, propagating the JWT in Metadata.

Write unit + E2E tests for gRPC paths
Â Â Â â€¢ Mock ClientGrpc in Authâ€‘unit tests; spin up a lightweight gRPC client in E2E to hit UserGrpcController.

Propagate metadata
Â Â Â â€¢ Ensure incoming REST JWTs are forwarded as gRPC metadata and validated by JwtAuthGuard on the gRPC side.

Phase 3: Full migration
Â Â Â â€¢ Gradually move all PrismaService userâ€‘fetches in AuthService â†’ gRPC, deprecating direct DB calls.