NebulaNV â€” Auth & gRPC Integration Update (26â€‘07â€‘2025)

ğŸ§© Modules Updated

AuthService
apps/user-service/src/auth/auth.service.ts

AuthModule
apps/user-service/src/auth/auth.module.ts

AuthController
apps/user-service/src/auth/auth.controller.ts

GrpcAuthService (gRPC client wrapper)
apps/user-service/src/auth/grpc/grpc-auth.service.ts

AuthGrpcController (RPC endpoints)
apps/user-service/src/auth/grpc/grpc-auth.controller.ts

UserController (HTTP â€œ/users/meâ€)
apps/user-service/src/user/user.controller.ts

UserService
apps/user-service/src/user/user.service.ts

UserGrpcController (gRPC â€œUserServiceâ€)
apps/user-service/src/user/grpc/user-grpc.controller.ts

GrpcJwtAuthGuard (extracts JWT from Metadata)
apps/user-service/src/user/grpc/grpc-jwt-auth.guard.ts

Main bootstrap (hybrid HTTPâ€‰+â€‰gRPC)
apps/user-service/src/main.ts

âœ… What Was Done

gRPC client in AuthService
â€“ Extracted all RPC calls (GetUser, UpdateProfile, FindUser) into a dedicated GrpcAuthService.
â€“ Centralized JWTâ€‘Bearer metadata via a buildJwtMeta(token) helper.

HTTP â†” gRPC split
â€“ HTTP controllers (AuthController, UserController) now handle DTOs, guards, and route definitions.
â€“ gRPC controllers (AuthGrpcController, UserGrpcController) expose @GrpcMethod() handlers and apply GrpcJwtAuthGuard.

DTOs & Validation
â€“ Reâ€‘enabled LoginUserDto with identifier (emailâ€¯orâ€¯phone).
â€“ Kept UpdateProfileDto for both HTTP and gRPC update flows, with conditional validators.

AuthModule enhancements
â€“ Registered USER_SERVICE gRPC client via ClientsModule.registerAsync().
â€“ Lifted ConfigModule and JwtModule to topâ€level imports for both HTTP and gRPC.

Hybrid application bootstrap
â€“ Switched to NestFactory.create(AppModule) + app.connectMicroservice({ transport: GRPC, â€¦ }).
â€“ Called app.startAllMicroservices() alongside app.listen(port).

TypeScript & path fixes
â€“ Corrected all protoPath references to join(__dirname, '..','proto','user.proto').
â€“ Generated user-service-client.interface.ts via tsâ€‘proto to mirror .proto messages/services.
â€“ Added nonâ€null assertions (req.user!) and aligned Nest/Microservices versions to eliminate addRpcTarget errors.

Mappers
â€“ Introduced dtoToProtoUpdate(id, dto) to translate HTTP DTO â†’ gRPC request shape.

Testing
â€“ Expanded unit tests for AuthService and UserService (Jest mocks for Prisma, bcrypt, JwtService).
â€“ Wrote test-grpc.js to smokeâ€‘test gRPC calls.
â€“ Adjusted and extended E2E tests (app.e2e-spec.ts) to cover /auth/* and /users/me flows.

ğŸ§ª Feature Verification

HTTP endpoints

POST /auth/register â†’ 201 Created

POST /auth/login with { identifier, password } â†’ { access_token, refresh_token }

GET /auth/me â†’ proxies to gRPC GetProfile â†’ returns { id, email, role }

POST /auth/refresh â†’ rotates tokens (201)

PUT /users/me â†’ updates email and/or password (200)

gRPC service

UserService.GetUser & UpdateProfile

JWT guard enforces metadata; returns proper NOT_FOUND or PERMISSION_DENIED codes

Tests

All unit tests passing (services, guards, controllers)

Manual gRPC smoke tests succeed

E2E tests now exercise full HTTPâ†’gRPC path

â­ï¸ Next Steps

Fix remaining E2E route mismatches

Consolidate profileâ€‘update under one controller (/auth/profile vs /users/me).

Enable full JWT metadata forwarding

Wire buildJwtMeta into GrpcAuthService calls so gRPC side can reâ€‘validate tokens.

Automate protoâ†’TS codegen

Smooth out protoc/tsâ€‘proto invocations on Windows & CI.

UserGrpcController tests

Add unit tests for RPC error mapping (e.g. 5â€¯=â€¯NOT_FOUND, 7â€¯=â€¯PERMISSION_DENIED).

Phaseâ€¯3 kickoff

Scaffold media-service UI integration and fileâ€‘manager per roadmap.