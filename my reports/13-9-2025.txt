NebulaNV â€” Settings Service & Testing Update (13-09-2025 Report)
ğŸ§© New & Updated Modules
Settings Service (HTTP & gRPC)

SettingsModule: added global ConfigModule import to allow .env usage.

SettingsGrpcController (apps/settings-service/src/grpc/settings-grpc.controller.ts):
â€“ Implements GetString and SetString RPCs.
â€“ Normalizes environment to "default" if omitted.
â€“ Passes arguments to SettingsService in order (namespace, key, value, environment).

SettingsService (apps/settings-service/src/settings.service.ts):
â€“ Implements getString (returns { value, found } with empty string fallback).
â€“ Implements setString (upserts row, clears other type columns, defaults environment).
â€“ Uses Prisma client connected to nebula_settings database.

Environment & Bootstrap

.env Standardization:
â€“ Moved to distinct files per service (PORT, *_GRPC_URL variables separated).
â€“ Removed cross-service leakage where settings-service accidentally picked product-serviceâ€™s .env.

main.ts Synchronization:
â€“ Product-service, auth-service, and settings-service main.ts updated to consistently use env-based ports.
â€“ gRPC URL/port collisions resolved (50060 reserved for settings-service).
â€“ Clear startup logging added for both HTTP & gRPC servers.

ğŸ§ª Testing Setup & Coverage
Jest Installation & Config

Installed and configured jest, ts-jest, @types/jest.

Updated package.json to include:

test, test:watch, test:cov, test:debug, test:e2e.

Postinstall still runs prisma generate to keep clients in sync.

Unit Tests â€” SettingsGrpcController

Created apps/settings-service/test/settings-grpc.controller.spec.ts.

Built tests step-by-step:

Used Test.createTestingModule to inject mocked SettingsService.

Tests Implemented:

âœ… GetString â€” ensures call argument order and verifies returned object { value, found }.

âœ… SetString â€” checks correct argument order (namespace, key, value, env) and return value.

âœ… Rejection scenario â€” verifies error propagation if service rejects.

âœ… Negative scenario â€” tests behavior when found is false (empty value returned).

Unit Tests â€” SettingsService

Created apps/settings-service/test/settings.service.spec.ts.

Mocked PrismaService with findFirst and upsert stubs.

Tests Implemented:

âœ… getString â€” returns correct value, defaults environment, returns empty string when row missing.

âœ… setString â€” upserts row, clears all other value types, respects environment default.

âœ… Results

All 12 tests passed across both test suites.

Verified that:

gRPC controller passes arguments in correct order.

Environment defaults work consistently in both controller and service.

Prisma calls are made with correct where and create/update objects.

âš ï¸ Warnings & Next Steps

Warnings:
â€“ ts-jest globals key deprecated â€” should move to transform section.
â€“ isolatedModules option needs to be set in tsconfig.json to remove future deprecation warning.

Recommended Next Steps:

Add E2E gRPC tests to validate full serialization/deserialization (optional but valuable).

Expand tests for trimming behavior (whitespace handling in namespace/key).

Integration: use product-service to set default_product_category at runtime and verify retrieval through settings-service.